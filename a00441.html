<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>HyPar: src/TridiagLU/tridiagLUGS.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HyPar
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Finite-Difference Hyperbolic-Parabolic PDE Solver on Cartesian Grids</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00441.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">tridiagLUGS.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Solve tridiagonal systems of equations in parallel using "gather-and-solve".  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;time.h&gt;</code><br />
<code>#include &lt;sys/time.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;mpi.h&gt;</code><br />
<code>#include &lt;<a class="el" href="a00119_source.html">tridiagLU.h</a>&gt;</code><br />
</div>
<p><a href="a00441_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ad485d12c99b8c48303b6bef2f86b135d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00441.html#ad485d12c99b8c48303b6bef2f86b135d">tridiagLUGS</a> (double *a, double *b, double *c, double *x, int n, int ns, void *r, void *m)</td></tr>
<tr class="separator:ad485d12c99b8c48303b6bef2f86b135d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Solve tridiagonal systems of equations in parallel using "gather-and-solve". </p>
<dl class="section author"><dt>Author</dt><dd>Debojyoti Ghosh </dd></dl>

<p>Definition in file <a class="el" href="a00441_source.html">tridiagLUGS.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ad485d12c99b8c48303b6bef2f86b135d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int tridiagLUGS </td>
          <td>(</td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>ns</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>r</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>m</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Solve tridiagonal (non-periodic) systems of equations using the gather-and-solve approach: This function can solve multiple independent systems with one call. The systems need not share the same left- or right-hand-sides. The "gather-and-solve" approach gathers a tridiagonal system on one processor and solves it using <a class="el" href="a00119.html#a83b53dedf034d67bf2dde46eebf492ee">tridiagLU()</a> (sending NULL as the argument for MPI communicator to indicate that a serial solution is desired). Given multiple tridiagonal systems (<em>ns</em> &gt; 1), this function will gather the systems on different processors in an optimal way, and thus each processor will solve some of the systems. After the system(s) is (are) solved, the solution(s) is (are) scattered back to the original processors.</p>
<p>Array layout: The arguments <em>a</em>, <em>b</em>, <em>c</em>, and <em>x</em> are local 1D arrays (containing this processor's part of the subdiagonal, diagonal, superdiagonal, and right-hand-side) of size (<em>n</em> X <em>ns</em>), where <em>n</em> is the local size of the system, and <em>ns</em> is the number of independent systems to solve. The ordering of the elements in these arrays is as follows:</p><ul>
<li>Elements of the same row for each of the independent systems are stored adjacent to each other.</li>
</ul>
<p>For example, consider the following systems: </p><p class="formulaDsp">
\begin{equation} \left[\begin{array}{ccccc} b_0^k &amp; c_0^k &amp; &amp; &amp; \\ a_1^k &amp; b_1^k &amp; c_1^k &amp; &amp; \\ &amp; a_2^k &amp; b_2^k &amp; c_2^k &amp; &amp; \\ &amp; &amp; a_3^k &amp; b_3^k &amp; c_3^k &amp; \\ &amp; &amp; &amp; a_4^k &amp; b_4^k &amp; c_4^k \\ \end{array}\right] \left[\begin{array}{c} x_0^k \\ x_1^k \\ x_2^k \\ x_3^k \\ x_4^k \end{array}\right] = \left[\begin{array}{c} r_0^k \\ r_1^k \\ r_2^k \\ r_3^k \\ r_4^k \end{array}\right]; \ \ k= 1,\cdots,ns \end{equation}
</p>
<p> and let \( ns = 3\). Note that in the code, \(x\) and \(r\) are the same array <em>x</em>.</p>
<p>Then, the array <em>b</em> must be a 1D array with the following layout of elements:<br />
[<br />
b_0^0, b_0^1, b_0^2, (diagonal element of the first row in each system) <br />
b_1^0, b_1^1, b_1^2, (diagonal element of the second row in each system) <br />
..., <br />
b_{n-1}^0, b_{n-1}^1, b_{n-1}^2 (diagonal element of the last row in each system) <br />
]<br />
The arrays <em>a</em>, <em>c</em>, and <em>x</em> are stored similarly.</p>
<p>Notes:</p><ul>
<li>This function does <em>not</em> preserve the sub-diagonal, diagonal, super-diagonal elements and the right-hand-sides.</li>
<li>The input array <em>x</em> contains the right-hand-side on entering the function, and the solution on exiting it. </li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">a</td><td>Array containing the sub-diagonal elements </td></tr>
    <tr><td class="paramname">b</td><td>Array containing the diagonal elements </td></tr>
    <tr><td class="paramname">c</td><td>Array containing the super-diagonal elements </td></tr>
    <tr><td class="paramname">x</td><td>Right-hand side; will contain the solution on exit </td></tr>
    <tr><td class="paramname">n</td><td>Local size of the system on this processor </td></tr>
    <tr><td class="paramname">ns</td><td>Number of systems to solve </td></tr>
    <tr><td class="paramname">r</td><td>Object of type <a class="el" href="a00119.html#a00464">TridiagLU</a> </td></tr>
    <tr><td class="paramname">m</td><td>MPI communicator </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="a00441_source.html#l00064">64</a> of file <a class="el" href="a00441_source.html">tridiagLUGS.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;{</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <a class="code" href="a00119.html#a00464">TridiagLU</a> *context = (<a class="code" href="a00119.html#a00464">TridiagLU</a>*) r;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordflow">if</span> (!context) {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;Error in tridiagLUGS(): NULL pointer passed for parameters.\n&quot;</span>);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordflow">return</span>(-1);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  }</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="preprocessor">#ifdef serial</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="comment">/* Serial compilation */</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordflow">return</span>(<a class="code" href="a00119.html#a83b53dedf034d67bf2dde46eebf492ee">tridiagLU</a>(a,b,c,x,n,ns,context,m));</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">int</span>         d,i,ierr = 0,dstart,istart,p,q;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">int</span>   nvar = 4;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">double</span>      *sendbuf,*recvbuf;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="keywordtype">int</span>         rank,nproc;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">/* Parallel compilation */</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  MPI_Comm  *comm = (MPI_Comm*) m;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordflow">if</span> (!comm) <span class="keywordflow">return</span>(<a class="code" href="a00119.html#a83b53dedf034d67bf2dde46eebf492ee">tridiagLU</a>(a,b,c,x,n,ns,context,NULL));</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  MPI_Comm_size(*comm,&amp;nproc);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  MPI_Comm_rank(*comm,&amp;rank);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">if</span> ((ns == 0) || (n == 0)) <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">/* </span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">    each process needs to know the local sizes of every other process </span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">    and total size of the system</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordtype">int</span> *N = (<span class="keywordtype">int</span>*) calloc (nproc, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  MPI_Allgather(&amp;n,1,MPI_INT,N,1,MPI_INT,*comm);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keywordtype">int</span> NT = 0; <span class="keywordflow">for</span> (i=0; i&lt;nproc; i++) NT += N[i];</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="comment">/* counts and displacements for gather and scatter operations */</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordtype">int</span> *counts = (<span class="keywordtype">int</span>*) calloc (nproc, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">int</span> *displ  = (<span class="keywordtype">int</span>*) calloc (nproc, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="comment">/* on all processes, calculate the number of systems each     */</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="comment">/* process has to solve                                       */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="keywordtype">int</span> *ns_local = (<span class="keywordtype">int</span>*) calloc (nproc,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keywordflow">for</span> (p=0; p&lt;nproc; p++)    ns_local[p] = ns / nproc; </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">for</span> (p=0; p&lt;ns%nproc; p++) ns_local[p]++;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">/* allocate the arrays for the gathered tridiagonal systems */</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="keywordtype">double</span> *ra=NULL,*rb=NULL,*rc=NULL,*rx=NULL; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordflow">if</span> (ns_local[rank] &gt; 0) {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    ra = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    rb = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    rc = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    rx = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="comment">/* Gather the systems on each process */</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="comment">/* allocate receive buffer */</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordflow">if</span> (ns_local[rank] &gt; 0) </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    recvbuf = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*nvar*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordflow">else</span> recvbuf = NULL;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  dstart = 0;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">for</span> (p = 0; p &lt; nproc; p++) {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">if</span> (ns_local[p] &gt; 0) {</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <span class="comment">/* allocate send buffer and form the send packet of data */</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      sendbuf = (<span class="keywordtype">double</span>*) calloc (nvar*n*ns_local[p],<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordflow">for</span> (d = 0; d &lt; ns_local[p]; d++) {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;          sendbuf[n*nvar*d+n*0+i] = a[d+dstart+ns*i];</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;          sendbuf[n*nvar*d+n*1+i] = b[d+dstart+ns*i];</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;          sendbuf[n*nvar*d+n*2+i] = c[d+dstart+ns*i];</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;          sendbuf[n*nvar*d+n*3+i] = x[d+dstart+ns*i];</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        }</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      }</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;      dstart += ns_local[p];</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      <span class="comment">/* gather these reduced systems on process with rank = p */</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      <span class="keywordflow">if</span> (rank == p) {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">for</span> (q = 0; q &lt; nproc; q++) {</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          counts[q] = nvar*N[q]*ns_local[p];</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;          displ [q] = (q == 0 ? 0 : displ[q-1]+counts[q-1]);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        }</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      MPI_Gatherv(sendbuf,nvar*n*ns_local[p],MPI_DOUBLE,</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                  recvbuf,counts,displ,MPI_DOUBLE,p,*comm);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      <span class="comment">/* deallocate send buffer */</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      free(sendbuf);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="comment">/* extract the data from the recvbuf and solve */</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  istart = 0;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keywordflow">for</span> (q = 0; q &lt; nproc; q++) {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">for</span> (d = 0; d &lt; ns_local[rank]; d++) {</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      <span class="keywordflow">for</span> (i = 0; i &lt; N[q]; i++) {</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        ra[d+ns_local[rank]*(istart+i)] = recvbuf[istart*nvar*ns_local[rank]+d*nvar*N[q]+0*N[q]+i];</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        rb[d+ns_local[rank]*(istart+i)] = recvbuf[istart*nvar*ns_local[rank]+d*nvar*N[q]+1*N[q]+i];</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        rc[d+ns_local[rank]*(istart+i)] = recvbuf[istart*nvar*ns_local[rank]+d*nvar*N[q]+2*N[q]+i];</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        rx[d+ns_local[rank]*(istart+i)] = recvbuf[istart*nvar*ns_local[rank]+d*nvar*N[q]+3*N[q]+i];</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      }</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    istart += N[q];</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  }</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="comment">/* deallocate receive buffer */</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="keywordflow">if</span> (recvbuf)  free(recvbuf);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="comment">/* solve the gathered systems in serial */</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  ierr = <a class="code" href="a00119.html#a83b53dedf034d67bf2dde46eebf492ee">tridiagLU</a>(ra,rb,rc,rx,NT,ns_local[rank],context,NULL);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="keywordflow">if</span> (ierr) <span class="keywordflow">return</span>(ierr);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="comment">/* allocate send buffer and save the data to send */</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keywordflow">if</span> (ns_local[rank] &gt; 0)</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    sendbuf = (<span class="keywordtype">double</span>*) calloc (ns_local[rank]*NT,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordflow">else</span> sendbuf = NULL;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  istart = 0;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keywordflow">for</span> (q = 0; q &lt; nproc; q++) {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; N[q]; i++) {</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      <span class="keywordflow">for</span> (d = 0; d &lt; ns_local[rank]; d++) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        sendbuf[istart*ns_local[rank]+d*N[q]+i] = rx[d+ns_local[rank]*(istart+i)];</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    istart += N[q];</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  }</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  dstart = 0;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordflow">for</span> (p = 0; p &lt; nproc; p++) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span> (ns_local[p] &gt; 0) {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="comment">/* allocate receive buffer */</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      recvbuf = (<span class="keywordtype">double</span>*) calloc (ns_local[p]*n, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="comment">/* scatter the solution back */</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="keywordflow">for</span> (q = 0; q &lt; nproc; q++) {</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        counts[q] = ns_local[p]*N[q];</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        displ[q]  = (q == 0 ? 0 : displ[q-1]+counts[q-1]);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      }</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      MPI_Scatterv(sendbuf,counts,displ,MPI_DOUBLE,</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                   recvbuf,ns_local[p]*n,MPI_DOUBLE,</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                   p,*comm);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      <span class="comment">/* save the solution on all root processes */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keywordflow">for</span> (d = 0; d &lt; ns_local[p]; d++) {</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;          x[d+dstart+ns*i] = recvbuf[d*n+i];</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      dstart += ns_local[p];</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <span class="comment">/* deallocate receive buffer */</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      free(recvbuf);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="comment">/* deallocate send buffer */</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keywordflow">if</span> (sendbuf) free(sendbuf);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  <span class="comment">/* clean up */</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordflow">if</span> (ns_local[rank] &gt; 0) {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    free(ra);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    free(rb);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    free(rc);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    free(rx);</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  free(ns_local);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  free(N);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  free(displ);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  free(counts);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;}</div>
<div class="ttc" id="a00119_html_a83b53dedf034d67bf2dde46eebf492ee"><div class="ttname"><a href="a00119.html#a83b53dedf034d67bf2dde46eebf492ee">tridiagLU</a></div><div class="ttdeci">int tridiagLU(double *, double *, double *, double *, int, int, void *, void *)</div><div class="ttdef"><b>Definition:</b> <a href="a00440_source.html#l00083">tridiagLU.c:83</a></div></div>
<div class="ttc" id="a00119_html_a00464"><div class="ttname"><a href="a00119.html#a00464">TridiagLU</a></div><div class="ttdef"><b>Definition:</b> <a href="a00119_source.html#l00081">tridiagLU.h:81</a></div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=10897352; 
var sc_invisible=1; 
var sc_security="83042f57"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="website
statistics" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="//c.statcounter.com/10897352/0/83042f57/1/"
alt="website statistics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
